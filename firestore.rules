rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ==================== USERS COLLECTION ====================
    // Users can only read/write their own user document
    match /users/{userId} {
      // Allow authenticated user to read their own profile
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Allow write to own profile during account creation (first write)
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Allow authenticated user to update their own profile
      allow update: if isAuthenticated() && isOwner(userId);
      
      // Allow user to delete their own profile
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ==================== PRODUCTS COLLECTION ====================
    // Users can only read/write their own products
    match /products/{productId} {
      // Allow authenticated user to read products they own
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to create products
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.name is string &&
                       request.resource.data.price is number &&
                       request.resource.data.quantity is number;
      
      // Allow authenticated user to update products they own
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to delete products they own
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }

    // ==================== SALES COLLECTION ====================
    // Users can only read/write their own sales records
    match /sales/{saleId} {
      // Allow authenticated user to read sales they own
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to create sales records
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.productId is string &&
                       request.resource.data.quantity is number &&
                       request.resource.data.totalAmount is number &&
                       request.resource.data.saleDate is timestamp;
      
      // Allow authenticated user to update sales they own
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to delete sales they own
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }

    // ==================== EXPENSES COLLECTION ====================
    // Users can only read/write their own expense records
    match /expenses/{expenseId} {
      // Allow authenticated user to read expenses they own
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to create expense records
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.category is string &&
                       request.resource.data.amount is number &&
                       request.resource.data.expenseDate is timestamp;
      
      // Allow authenticated user to update expenses they own
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // Allow authenticated user to delete expenses they own
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }

    // ==================== DEFAULT DENY ====================
    // Explicitly deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
